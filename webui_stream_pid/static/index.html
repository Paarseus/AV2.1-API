<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f0f0f">
    <link rel="manifest" href="/static/manifest.json">
    <title>AV Console</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.2/nipplejs.min.js"></script>
    <style>
        :root {
            --bg: #0f0f0f;
            --surface: #1a1a1a;
            --surface-alt: #252525;
            --border: #333333;
            --text: #ffffff;
            --text-secondary: #888888;
            --accent: #2196f3;
            --green: #4caf50;
            --red: #f44336;
            --orange: #ff9800;
            --estop-height: 56px;
            --bar-height: 44px;
            --footer-height: 48px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100dvh;
            display: grid;
            grid-template-rows: var(--estop-height) var(--bar-height) auto auto 1fr var(--footer-height);
            touch-action: none;
            user-select: none;
            overflow: hidden;
        }

        /* E-STOP */
        #estop {
            background: var(--red);
            color: var(--text);
            font-size: 20px;
            font-weight: 700;
            border: none;
            width: 100%;
            height: 100%;
            cursor: pointer;
            transition: background 0.15s;
        }
        #estop.active {
            background: #b71c1c;
            animation: pulse 0.5s infinite alternate;
        }
        @keyframes pulse {
            to { background: #d32f2f; }
        }

        /* Header/Toolbar */
        #toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            gap: 8px;
        }

        .modes {
            display: flex;
            gap: 6px;
        }
        .modes button {
            background: var(--surface-alt);
            color: var(--text-secondary);
            border: none;
            padding: 8px 14px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            min-width: 40px;
            transition: all 0.15s;
        }
        .modes button.active {
            background: var(--accent);
            color: var(--text);
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #lock-btn {
            background: transparent;
            border: none;
            color: var(--green);
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        #lock-btn.released { color: var(--orange); }
        #lock-btn svg.hidden { display: none; }

        #status {
            font-size: 12px;
            color: var(--green);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        #status::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--green);
            border-radius: 50%;
        }
        #status.disconnected { color: var(--red); }
        #status.disconnected::before { background: var(--red); }

        #video-toggle {
            background: var(--surface-alt);
            border: none;
            color: var(--text-secondary);
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        #video-toggle.hidden { display: none; }

        /* Video Section */
        #video-section {
            position: relative;
            background: #000;
            overflow: hidden;
            transition: height 0.2s ease;
        }
        #video-section.expanded { height: 20vh; }
        #video-section.collapsed { height: 0; }

        #remote-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #video-overlay {
            position: absolute;
            bottom: 8px;
            left: 12px;
            font-family: 'SF Mono', 'Menlo', monospace;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }

        #video-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-secondary);
            font-size: 13px;
        }
        #video-status.hidden { display: none; }

        #video-collapse-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.6);
            border: none;
            color: var(--text);
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Control Mode Toggle */
        #control-mode {
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            background: var(--surface);
        }

        .mode-toggle-btn {
            flex: 1;
            padding: 10px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: var(--surface-alt);
            color: var(--text-secondary);
            transition: all 0.15s;
        }
        .mode-toggle-btn.active {
            background: var(--accent);
            color: var(--text);
        }
        .mode-toggle-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Cruise Panel */
        #cruise-panel {
            background: var(--surface);
            border-top: 1px solid var(--border);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease, padding 0.2s ease;
            padding: 0 12px;
        }
        #cruise-panel.visible {
            max-height: 120px;
            padding: 12px;
        }

        .cruise-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        .cruise-row:last-child { margin-bottom: 0; }

        .cruise-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .cruise-speed {
            font-family: 'SF Mono', 'Menlo', monospace;
            font-size: 20px;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }

        .cruise-btn {
            padding: 8px 14px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            min-width: 44px;
            min-height: 44px;
            transition: all 0.15s;
        }
        .cruise-btn-adjust {
            background: var(--surface-alt);
            color: var(--text);
        }
        .cruise-btn-adjust:active { background: #333; }

        #cruise-engage {
            background: #388e3c;
            color: var(--text);
            flex: 1;
            max-width: 120px;
        }
        #cruise-engage.engaged { background: var(--accent); }

        #cruise-cancel {
            background: var(--red);
            color: var(--text);
            flex: 1;
            max-width: 120px;
        }

        .cruise-status {
            text-align: center;
            font-size: 11px;
            color: var(--text-secondary);
        }
        .cruise-status.engaged { color: var(--green); }
        .cruise-status.gps-error { color: var(--red); }

        /* Joystick Zone */
        #joystick-zone {
            background: #111;
            position: relative;
            min-height: 30vh;
        }

        /* Footer */
        #footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            background: var(--surface);
            border-top: 1px solid var(--border);
        }

        #telemetry {
            font-family: 'SF Mono', 'Menlo', monospace;
            font-size: 13px;
            color: var(--text-secondary);
        }

        #footer-speed {
            font-family: 'SF Mono', 'Menlo', monospace;
            font-size: 13px;
            color: var(--green);
        }
        #footer-speed.hidden { display: none; }

        #mic-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--surface-alt);
            color: var(--text);
            border: 2px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        #mic-btn.listening {
            background: var(--red);
            border-color: var(--red);
        }
        #mic-btn.success {
            background: var(--green);
            border-color: var(--green);
        }

        /* Blocked Overlay */
        #blocked-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        #blocked-overlay.hidden { display: none; }

        .blocked-content {
            text-align: center;
            color: var(--text-secondary);
        }
        .blocked-content h1 {
            font-size: 22px;
            color: var(--red);
            margin-bottom: 8px;
        }

        #retry-btn {
            margin-top: 20px;
            padding: 12px 32px;
            font-size: 15px;
            background: var(--surface-alt);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
        }

        /* Landscape Layout */
        @media (orientation: landscape) and (min-width: 600px) {
            body {
                grid-template-columns: 35% 1fr;
                grid-template-rows: 48px 1fr;
            }

            #estop {
                grid-column: 1 / -1;
                font-size: 18px;
            }

            #left-panel {
                display: flex;
                flex-direction: column;
                background: var(--surface);
                border-right: 1px solid var(--border);
            }

            #right-panel {
                display: flex;
                flex-direction: column;
            }

            #toolbar {
                border-bottom: none;
            }

            #video-section {
                flex: 1;
            }
            #video-section.expanded { height: auto; }
            #video-section.collapsed { height: 0; flex: 0; }

            #left-footer {
                padding: 10px 12px;
                background: var(--bg);
                border-top: 1px solid var(--border);
            }

            #control-mode {
                border-bottom: 1px solid var(--border);
            }

            #joystick-zone {
                flex: 1;
                min-height: auto;
            }

            #footer {
                display: none;
            }

            #right-footer {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 12px;
                height: 48px;
                background: var(--surface);
                border-top: 1px solid var(--border);
            }
        }

        @media (orientation: portrait) {
            #left-panel, #right-panel, #left-footer, #right-footer {
                display: contents;
            }
        }
    </style>
</head>
<body>
    <div id="blocked-overlay" class="hidden">
        <div class="blocked-content">
            <h1>Controller In Use</h1>
            <p>Another device is controlling the vehicle</p>
            <button id="retry-btn">Retry</button>
        </div>
    </div>

    <button id="estop">E-STOP</button>

    <div id="left-panel">
        <header id="toolbar">
            <div class="modes">
                <button data-mode="N" class="active">N</button>
                <button data-mode="D">D</button>
                <button data-mode="S">S</button>
                <button data-mode="R">R</button>
            </div>
            <div class="toolbar-right">
                <button id="lock-btn" title="Release Teensy for external control">
                    <svg id="lock-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                    </svg>
                    <svg id="unlock-icon" class="hidden" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"/>
                    </svg>
                </button>
                <div id="status">Live</div>
                <button id="video-toggle" class="hidden">▼ CAM</button>
            </div>
        </header>

        <section id="video-section" class="expanded">
            <video id="remote-video" autoplay playsinline muted></video>
            <div id="video-status">Connecting camera...</div>
            <div id="video-overlay">0.0 m/s</div>
            <button id="video-collapse-btn">▲</button>
        </section>

        <div id="left-footer">
            <div id="telemetry">T: 0.00  S: 0.00  B: 0.00</div>
            <button id="mic-btn-landscape" style="display:none;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
            </button>
        </div>
    </div>

    <div id="right-panel">
        <section id="control-mode">
            <button id="mode-direct" class="mode-toggle-btn active">DIRECT</button>
            <button id="mode-cruise" class="mode-toggle-btn">CRUISE</button>
        </section>

        <section id="cruise-panel">
            <div class="cruise-row">
                <span class="cruise-label">Target:</span>
                <button id="cruise-dec" class="cruise-btn cruise-btn-adjust">−</button>
                <span id="cruise-speed-display" class="cruise-speed">1.0 m/s</span>
                <button id="cruise-inc" class="cruise-btn cruise-btn-adjust">+</button>
            </div>
            <div class="cruise-row">
                <button id="cruise-engage" class="cruise-btn">ENGAGE</button>
                <button id="cruise-cancel" class="cruise-btn">CANCEL</button>
            </div>
            <div id="cruise-status" class="cruise-status">Disengaged</div>
        </section>

        <main id="joystick-zone"></main>

        <div id="right-footer">
            <div id="telemetry-landscape">T: 0.00  S: 0.00  B: 0.00</div>
        </div>
    </div>

    <footer id="footer">
        <div>
            <div id="telemetry-portrait">T: 0.00  S: 0.00  B: 0.00</div>
            <div id="footer-speed" class="hidden">0.0 m/s</div>
        </div>
        <button id="mic-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
            </svg>
        </button>
    </footer>

    <script src="/static/app.js"></script>
</body>
</html>
